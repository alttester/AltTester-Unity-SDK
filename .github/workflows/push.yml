name: Push
on:
  push:
  workflow_dispatch:

jobs:
  build-docs:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10' 
          cached: 'pip'
      - uses: syphar/restore-virtualenv@v1
        id: cache-virtualenv

      - uses: syphar/restore-pip-download-cache@v1
        if: steps.cache-virtualenv.outputs.cache-hit != 'true'

      - run: pip install -r Docs/requirements.txt
        if: steps.cache-virtualenv.outputs.cache-hit != 'true'
      - run: pwd
      - uses: rickstaa/sphinx-action@master
        with:
          docs-folder: Docs
          build-command: make html

      - uses: actions/upload-artifact@v1
        with:
          name: DocumentationHTML
          path: Docs/build/html/
         
  build-macOS:
      runs-on: self-hosted
      steps:
        - uses: actions/checkout@v3

        - run: |
            $UNITY_2021_3_HOME -batchmode -stackTraceLogType None -projectPath $CI_PROJECT_DIR -executeMethod Altom.AltUnityTesterTools.BuildAltUnityTester.MacBuildFromCommandLine -logFile buildMac.log -quit

        - run: ls
        - uses: actions/upload-artifact@v3.1.0
          if: always() # run this step even if one of the previous step failed
          with:
            name: BuildMacArtifact
            path: |
              sampleGame.app
              buildMac.log
            
  test-CSharp-Editor:
    runs-on: self-hosted
    needs: build-macOS
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3.0.0
        with:
          name: 
            BuildMacArtifact
      - run: |
          chmod -R 755  sampleGame.app
          open sampleGame.app
          $UNITY_2021_3_HOME -batchmode -stackTraceLogType None -projectPath $CI_PROJECT_DIR -executeMethod Altom.AltUnityTesterEditor.AltUnityTestRunner.RunTestFromCommandLine -testsAssembly Assembly-CSharp-Editor  -logFile csharpAndroidTests.log -quit 
      #TODO add back -reportPath $CI_PROJECT_DIR/reportTest.xml for removing because it's giving me unauthorized error
      - uses: actions/upload-artifact@v3.1.0
        if: always() # run this step even if one of the previous step failed
        with:
          name: TestCSharpArtifact
          path: |
            csharpAndroidTests.log
            reportTest.xml
            
  test-DotNet:
      runs-on: self-hosted
      needs: build-macOS
      steps:
        - uses: actions/checkout@v3
        - uses: actions/download-artifact@v3.0.0
          with:
            name: 
              BuildMacArtifact
        - name: Setup .NET Core SDK
          uses: actions/setup-dotnet@v2.1.1
        - run: |
            chmod -R 755  sampleGame.app
            open sampleGame.app
            dotnet test Bindings~/dotnet/AltUnityDriver.Tests/AltUnityDriver.Tests.csproj --logger:"console;verbosity=detailed"

        - uses: actions/upload-artifact@v3.1.0
          if: always() # run this step even if one of the previous step failed
          with:
            name: TestCSharpArtifact
            path: |
              csharpAndroidTests.log
              AltUnityTesterLog.txt
              AltUnityServerLog.txt
  test-Python:
      runs-on: self-hosted
      needs: build-macOS
      steps:
        - uses: actions/checkout@v3
        - uses: actions/download-artifact@v3.0.0
          with:
            name: 
              BuildMacArtifact
        - uses: actions/setup-python@v4
          with:
            python-version: '3.10' 
            cached: 'pip'
        - uses: syphar/restore-virtualenv@v1
          id: cache-virtualenv

        - uses: syphar/restore-pip-download-cache@v1
          if: steps.cache-virtualenv.outputs.cache-hit != 'true'

        - run: pip install -r "Bindings~/python/requirements.txt"
        - run: pip install -r "Bindings~/python/requirements-dev.txt"
        - run: pip install -e "Bindings~/python" --root "Bindings~/python"
        
        - run: |
            chmod -R 755  sampleGame.app
            open sampleGame.app
            pytest Bindings~/python/tests/integration -x
            

        - uses: actions/upload-artifact@v3.1.0
          if: always() # run this step even if one of the previous step failed
          with:
            name: TestPythonArtifact
            path: |
              AltUnityTesterLog.txt
              AltUnityServerLog.txt

  test-Java:
      runs-on: self-hosted
      needs: build-macOS
      steps:
        - uses: actions/checkout@v3
        - uses: actions/download-artifact@v3.0.0
          with:
            name: 
              BuildMacArtifact
              
        - name: Setup Java JDK
          uses: actions/setup-java@v3.5.1
          with:
              distribution: temurin
              java-version: 11
        - uses: stCarolas/setup-maven@v4.4
        - run: |
            chmod -R 755  sampleGame.app
            open sampleGame.app
            cd "Bindings~/java"
            mvn -Dtest=ro.altom.altunitytester.Tests* test

        - uses: actions/upload-artifact@v3.1.0
          if: always() # run this step even if one of the previous step failed
          with:
            name: TestJavaArtifact
            path: |
              AltUnityTesterLog.txt
              AltUnityServerLog.txt
              
      